<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>Gọi Món</title>
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#f5f7fa">
<meta name="application-name" content="Đơn Hàng TV">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Đơn Hàng TV">
<link rel="preconnect" href="https://script.google.com" crossorigin>
<link rel="dns-prefetch" href="https://script.google.com">
<style>*{margin:0;padding:0;box-sizing:border-box}html,body{height:100%;width:100%}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#000;color:#2c3e50;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-overflow-scrolling:touch;min-height:100vh;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);-ms-overflow-style:none;scrollbar-width:none}::-webkit-scrollbar{display:none}.container{min-height:100vh;padding:15px 15px 80px;scroll-behavior:smooth}.order-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;max-width:100%;will-change:contents}.order-row{background:#fff;border-radius:16px;padding:3px 2px;border:0.05px solid #e0e0e0;transition:transform .3s;display:grid;grid-template-columns:50px 38px 1fr;align-items:center;gap:13px;cursor:pointer;min-height:24px;position:relative;will-change:transform;box-shadow:0 2px 8px rgba(0,0,0,0.08);border-left:4px solid #02a046}.order-row:hover{transform:translateY(-3px)scale(1.02);border-color:#02a046;background:#fff;box-shadow:0 4px 15px rgba(0,0,0,0.12)}.time{font-size:.672rem;font-weight:700;color:#fff;text-shadow:none;display:flex;align-items:center;justify-content:center;padding:2px 10px;white-space:nowrap;background:linear-gradient(135deg,#27ae60 0%,#229954 100%);border-radius:20px;box-shadow:0 2px 8px rgba(39,174,96,0.3)}.table-number{font-size:.624rem;font-weight:700;color:#2c3e50;background:#02a046;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;padding:0px 3px;text-align:center;white-space:nowrap;display:flex;align-items:center;justify-content:center}.table-number.takeaway{background:linear-gradient(135deg,#f5652a 0%,#d35400 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}.dish-details-column{display:flex;flex-direction:column;gap:5px}.dish-item{position:relative;display:grid;grid-template-columns:30px 1fr;align-items:center;gap:8px;background:#f8f9fa;border-radius:10px;padding:2px;margin:0}.dish-note{position:absolute;right:3px;top:0;bottom:0;display:flex;align-items:center;white-space:nowrap;text-align:right;pointer-events:none;font-size:.456rem;padding:0px 1px;opacity:.95;color:#856404;font-weight:600;font-style:italic;background:#fff3cd;border-radius:8px;border:1px solid #ffc107}.dish-note:empty{display:none}.quantity{font-size:.624rem;font-weight:700;color:#fff;background:#02a046;padding:0px 0px;border-radius:12px;text-align:center;text-shadow:none;min-width:28px;box-shadow:none;}.dish{padding:2px 4px;font-size:.72rem;font-weight:700;text-shadow:none;white-space:nowrap;color:#2c3e50;z-index:1}.controls{position:fixed;bottom:10px;right:20px;display:none;gap:18px;z-index:1000;flex-direction:column;align-items:flex-end}.is-pwa .controls{bottom:20px}.btn{background:#02a046;border:none;color:#fff;padding:6px;border-radius:30px;cursor:pointer;font-size:.5rem;font-weight:600;transition:all .3s;-webkit-tap-highlight-color:transparent;box-shadow:0 4px 12px rgba(102,126,234,0.4)}.btn:active{background:#02a046;transform:scale(0.95)}.modal{display:none;position:fixed;z-index:2000;inset:0;overflow:auto;background-color:rgba(0,0,0,.7)}.modal-content{background:#fff;border:2px solid #e0e0e0;padding:12px 4px;border-radius:20px;width:80%;max-width:420px;text-align:center;position:relative;height:60vh;margin:30vh auto;display:flex;flex-direction:column;box-shadow:0 8px 32px rgba(0,0,0,0.3)}.modal-content h2{margin-bottom:10px;font-size:1.5rem;font-weight:700;text-shadow:none;color:#2c3e50}.close-btn{color:#7f8c8d;position:absolute;top:10px;right:10px;font-size:18px;font-weight:300;cursor:pointer;transition:all .3s ease;border-radius:50%;width:16px;height:16px;display:flex;align-items:center;justify-content:center}.close-btn:hover{color:#2c3e50;background:rgba(0,0,0,.05);transform:scale(1.1)}.table-selection-grid{display:grid;margin-top:8px;overflow-y:auto;flex-grow:1;grid-template-columns:repeat(3,1fr);gap:5px;padding:0}.table-btn{background:#02a046;border:none;color:#fff;cursor:pointer;font-size:2rem;font-weight:700;transition:all .3s;-webkit-tap-highlight-color:transparent;aspect-ratio:1/1;border-radius:12px;padding:0;display:flex;align-items:center;justify-content:center;width:70px;justify-self:center;box-shadow:0 4px 12px rgba(102,126,234,0.4)}.take-away-btn{font-size:1.2rem;line-height:1.2;padding:5px;background:linear-gradient(135deg,#f5652a,#d35400)!important;box-shadow:0 4px 12px rgba(230,126,34,0.4)!important}.table-btn:active{background:#02a046;transform:translateY(-3px)scale(1.05)}.kitchen-mode .order-row{cursor:default!important}.kitchen-mode .order-row:hover{transform:none!important;border-color:#e0e0e0!important;background:#fff!important}.delete-btn{position:absolute;top:0;left:3px;width:16px;height:16px;background-color:#e74c3c;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;cursor:pointer;z-index:10;transition:all .2s ease;opacity:0;box-shadow:0 2px 6px rgba(231,76,60,0.4)}.order-row:hover .delete-btn{opacity:1}.delete-btn:hover{background-color:#c0392b;transform:scale(1.1)}.order-row.deleting{transition:all .4s ease-out;opacity:0;transform:scale(.95)}@media (hover:none)and (pointer:coarse){.delete-btn{opacity:1}}.confirm-modal-content{background:#fff;border:2px solid #e0e0e0;padding:20px;border-radius:20px;width:90%;max-width:350px;text-align:center;position:relative;margin:40vh auto;box-shadow:0 8px 32px rgba(0,0,0,0.3)}.confirm-modal-content p{font-size:1.2rem;margin-bottom:25px;color:#2c3e50;line-height:1.5}.confirm-buttons{display:flex;justify-content:center;gap:20px}.btn-confirm{border:none;padding:10px 30px;border-radius:20px;font-size:1rem;font-weight:700;cursor:pointer;transition:all .2s ease}.btn-yes{background-color:#e74c3c;color:#fff;box-shadow:0 4px 12px rgba(231,76,60,0.4)}.btn-yes:hover{background-color:#c0392b;transform:scale(1.05)}.btn-no{background-color:#7f8c8d;color:#fff;box-shadow:0 4px 12px rgba(127,140,141,0.4)}.btn-no:hover{background-color:#95a5a6;transform:scale(1.05)}.table-number.blink-table{animation:none}.loading-spinner{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:3000}.spinner{width:16px;height:16px;border:2px solid rgba(102,126,234,.3);border-top:2px solid #02a046;border-radius:50%;animation:spin 1s linear infinite}.loading-state{display:flex;justify-content:center;align-items:center;height:80vh;text-align:center;padding:20px;color:#02a046;font-size:1.8rem;font-weight:700;animation:pulse 1.5s ease-in-out infinite}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}#staffControls{display:none}.pin-inputs{display:flex;gap:10px;justify-content:center;margin:20px 0}.pin-digit{width:45px;height:55px;text-align:center;font-size:1.5rem;font-weight:700;background-color:#f8f9fa;border:2px solid #e0e0e0;color:#2c3e50;border-radius:8px;-moz-appearance:textfield}.pin-digit::-webkit-outer-spin-button,.pin-digit::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}.pin-digit:focus{outline:0;border-color:#02a046;box-shadow:0 0 0 3px rgba(102,126,234,0.2)}@media (min-width:1920px){.order-grid{gap:8px}.order-row{padding:5px 9px;grid-template-columns:100px 60px 1fr;gap:15px;min-height:28px}.time{font-size:1.1rem; padding:0px 15px}.table-number,.quantity{font-size:1.6rem}.dish{font-size:2.5rem;padding:-2px 0}.dish-note{font-size:1rem}}@media (max-width:768px){.container{padding:7px 4px 55px}.order-grid{grid-template-columns:1fr;gap:8px}.order-row{grid-template-columns:58px 58px 1fr;gap:7px;padding:3px 0;min-height:28px}.dish-item{grid-template-columns:30px 1fr}.time{font-size:1rem}.table-number{font-size:1.14rem}.quantity{font-size:1.15rem;padding:0px -5px}.dish{font-size:1.18rem}.dish-note{font-size:.8rem;padding:0}.btn{font-size:.8rem;padding:8px}}@media (min-width:769px)and (max-width:1919px){.order-grid{grid-template-columns:1fr 1fr;column-gap:60px;row-gap:8px}.order-row{grid-template-columns:75px 70px 1fr;gap:12px}.dish-item{grid-template-columns:45px 1fr}.time,.table-number,.quantity{font-size:calc(.8rem + 8px)}.dish{font-size:calc(.9rem + 8px)}.dish-note{font-size:calc(.7rem + 8px)}.modal-content{height:80vh;margin:10vh auto}}@media (orientation:landscape)and (max-height:600px){.container{height:100vh;padding:4px 4px 36px}.order-row{padding:3px 5px}.modal-content{height:80vh;margin:10vh auto}}.order-row[data-minutes="11-15"]{border-left-color:#e74c3c}.order-row[data-minutes="11-15"] .time{background:linear-gradient(135deg,#e74c3c 0%,#c0392b 100%);box-shadow:0 2px 8px rgba(231,76,60,0.4)}.order-row[data-minutes="6-10"]{border-left-color:#f29a02}.order-row[data-minutes="6-10"] .time{background:linear-gradient(135deg,#f29a02 0%,#f29a02 100%);box-shadow:0 2px 8px rgba(230,126,34,0.4)}.order-row[data-minutes="0-5"] .time{background:linear-gradient(135deg,#02a046 0%,#02a046 100%);box-shadow:0 2px 8px rgba(2,160,70,0.4)}</style>
</head>
<body>
<div class="loading-spinner" id="s"><div class="spinner"></div></div>
<div class="container"><div id="l" class="order-grid"></div></div>
<div class="controls" id="c"><button class="btn" onclick="n()">&#10133; Thêm đơn mới</button></div>
<div id="m" class="modal"><div class="modal-content"><span class="close-btn" onclick="C()">&times;</span><h2>Chọn bàn để đặt món</h2><div class="table-selection-grid"></div></div></div>
<div id="cm" class="modal"><div class="confirm-modal-content"><p id="cmt">Đã hoàn thành, bạn muốn xóa ?</p><div class="confirm-buttons"><button id="y" class="btn-confirm btn-yes">Yes</button><button id="no" class="btn-confirm btn-no">No</button></div></div></div>
<div id="pm" class="modal"><div class="confirm-modal-content"><p>Vui lòng nhập mật khẩu</p><div class="pin-inputs" id="pi"><input type="number" class="pin-digit" maxlength="1"><input type="number" class="pin-digit" maxlength="1"><input type="number" class="pin-digit" maxlength="1"><input type="number" class="pin-digit" maxlength="1"></div><div class="confirm-buttons"><button id="pc" class="btn-confirm btn-no">Hủy</button></div></div></div>
<script>const U='https://script.google.com/macros/s/AKfycbyKF5oveUu5A1s4M7BnrK3ftbpwQSEB_V20-BbF7PsgrFAQ5y3neTi7xMDudM08iph32A/exec',O='https://anchay.vercel.app/',R=6e4,T=5e4,M=15,K='offlineOrders',KT='cacheTime',TL=12e4;const p=new URLSearchParams(location.search),k=p.get('mode')==='kitchen';let a,o=[],oc=new Map,f=!1,r=null,ml=!1,mo=!1,lt=0;const m=document.getElementById('m'),l=document.getElementById('l'),s=document.getElementById('s'),c=document.getElementById('c'),cm=document.getElementById('cm'),cmt=document.getElementById('cmt'),y=document.getElementById('y'),no=document.getElementById('no'),bc=document.querySelector('.confirm-buttons');async function L(){const v=await P();if(!v){r=null;return}r=v==='8899'?'Admin':v==='0000'?'Taicho':v==='1111'?'Muave':null;if(!r)A("Mật khẩu không đúng")}function A(mg){cmt.textContent=mg;y.textContent='Thoát';no.style.display='none';bc.style.justifyContent='center';cm.style.display='block';const cl=()=>{cm.style.display='none';y.textContent='Yes';no.style.display='';bc.style.justifyContent='';y.onclick=null};y.onclick=cl}function cr(o){const d=o.dishes.map((h,i)=>{const q=o.quantities[i],n=o.notes[i],nc=n?'dish-note':'dish-note empty';return`<div class="dish-item"><div class="quantity">${q}</div><div class="dish">${h}</div><div class="${nc}">${n||''}</div></div>`}).join('');const t=new Date,dm=Math.min(Math.max(0,Math.round((t-o.time)/6e4)),M);let timeClass='0-5';if(dm>=6&&dm<=10)timeClass='6-10';else if(dm>=11)timeClass='11-15';return`<div class="order-row" data-minutes="${timeClass}" onclick="${k?'':'h(this)'}"><span class="delete-btn" onclick="D('${o.orderNumber}',this.parentElement,event)">×</span><div class="time" data-timestamp="${o.time.toISOString()}">${dm} phút</div><div class="table-number ${o.tableNumber==='Mua về'?'takeaway':''}">${o.tableNumber}</div><div class="dish-details-column">${d}</div></div>`}function h(e){if(k)return;e.style.transform='scale(1.02)';e.style.background='#f0f0f0';setTimeout(()=>{e.style.transform='';e.style.background=''},200)}function d(x){const st=x.sort((a,b)=>a.time-b.time),t=new Date,rc=st.filter(o=>(t-o.time)/6e4<=15),od=st.filter(o=>(t-o.time)/6e4>15),ds=[...od.slice(-2),...rc];l.innerHTML=ds.map(cr).join('')}function u(){const t=new Date;document.querySelectorAll('.time[data-timestamp]').forEach(e=>{const ts=new Date(e.dataset.timestamp),mn=Math.min(Math.max(0,Math.round((t-ts)/6e4)),M);e.textContent=`${mn} phút`;const row=e.closest('.order-row');if(row){let tc='0-5';if(mn>=6&&mn<=10)tc='6-10';else if(mn>=11)tc='11-15';row.setAttribute('data-minutes',tc)}})}function gc(){try{const t=localStorage.getItem(KT);if(!t||Date.now()-parseInt(t)>TL)return null;const dt=localStorage.getItem(K);if(!dt)return null;const ps=JSON.parse(dt);return ps.map(o=>({...o,time:new Date(o.time)}))}catch(e){return null}}function sc(dt){try{localStorage.setItem(K,JSON.stringify(dt));localStorage.setItem(KT,Date.now().toString())}catch(e){}}function sl(){l.innerHTML='<div class="loading-state">Hãy + Thêm đơn mới !</div>'}async function F(){if(f)return;f=!0;try{const rs=await fetch(`${U}?action=getOfflineOrders`,{cache:'no-store'}),dt=await rs.json();if(!dt||!dt.length){f=!1;return}const g={};dt.forEach(i=>{if(!g[i.orderId])g[i.orderId]={time:new Date(i.time),orderNumber:i.orderId,tableNumber:i.tableNumber,quantities:[],dishes:[],notes:[]};g[i.orderId].quantities.push(i.quantity);g[i.orderId].dishes.push(i.dish);g[i.orderId].notes.push(i.note)});o=Object.values(g);sc(o);d(o)}catch(e){}finally{f=!1}}function lm(){const g=document.querySelector('.table-selection-grid');g.innerHTML=Array.from({length:14},(_,i)=>`<button class="table-btn" onclick="st(${i+1})">${i+1}</button>`).join('')+`<button class="table-btn take-away-btn" onclick="tw()">Mua về</button>`;ml=!0}function om(){if(!ml)lm();m.style.display='block';mo=!0;history.pushState({page:'modal'},'',location.href)}function st(n){ss();setTimeout(()=>{open(`${O}?table=${n}&mode=offline`,'_blank');hs();C()},500)}function tw(){ss();setTimeout(()=>{open(`${O}?table=takeaway&mode=offline`,'_blank');hs();C()},500)}function C(){m.style.display='none';mo=!1}function ss(){s.style.display='block'}function hs(){s.style.display='none'}function n(){if(k)return;if(navigator.vibrate)navigator.vibrate(50);om()}function sb(){setTimeout(()=>{history.replaceState({page:'init'},'',location.href);history.pushState({page:'home'},'',location.href)},500)}function sc2(mg){return new Promise(rv=>{cmt.textContent=mg;cm.style.display='block';mo=!0;history.pushState({page:'confirm'},'',location.href);const cl=()=>{cm.style.display='none';mo=!1;y.onclick=null;no.onclick=null};y.onclick=()=>{cl();rv(!0)};no.onclick=()=>{cl();rv(!1)}})}function P(){return new Promise(rv=>{const md=document.getElementById('pm'),ip=Array.from(md.querySelectorAll('.pin-digit')),cb=document.getElementById('pc');md.style.display='block';ip.forEach(i=>i.value='');ip[0].focus();const cl=v=>{md.style.display='none';rv(v)};const hi=e=>{const i=e.target,ix=ip.indexOf(i);if(i.value&&ix<ip.length-1)ip[ix+1].focus();if(ip.every(i=>i.value))cl(ip.map(i=>i.value).join(''))};const hk=e=>{if(e.key==='Backspace'){const ix=ip.indexOf(e.target);if(e.target.value===''&&ix>0)ip[ix-1].focus()}};ip.forEach(i=>{i.addEventListener('input',hi);i.addEventListener('keydown',hk)});cb.onclick=()=>cl(null)})}async function D(id,el,e){e.stopPropagation();const od=o.find(o=>o.orderNumber===id);if(!od){alert("Lỗi: Không tìm thấy thông tin đơn hàng.");return}const tn=od.tableNumber;let hp=!1;if(r==='Admin')hp=!0;else if(r==='Taicho'&&tn.startsWith('Bàn'))hp=!0;else if(r==='Muave'&&tn==='Mua về')hp=!0;if(!hp){A('Bạn KHÔNG có quyền xóa đơn này');return}const ok=await sc2("Đã hoàn thành, bạn muốn xóa ?");if(!ok)return;el.classList.add('deleting');setTimeout(()=>el.remove(),400);try{await fetch(U,{method:'POST',mode:'no-cors',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'markOrderAsCompleted',orderId:id})})}catch(e){alert('Có lỗi xảy ra khi xóa đơn hàng.');el.classList.remove('deleting')}}function sk(){c.style.display='none';document.body.classList.add('kitchen-mode')}function ss2(){c.style.setProperty('display','flex','important')}function sf(){const is=matchMedia('(display-mode: standalone)').matches||navigator.standalone||document.referrer.includes('android-app://');if(is){document.body.classList.add('is-pwa');return}function th(){scrollTo(0,1);setTimeout(()=>scrollTo(0,0),0)}function ha(){requestAnimationFrame(()=>requestAnimationFrame(th))}ha();addEventListener('load',()=>{setTimeout(ha,100);setTimeout(ha,300);setTimeout(ha,500)});let rt;addEventListener('resize',()=>{clearTimeout(rt);rt=setTimeout(ha,100)});addEventListener('orientationchange',()=>{setTimeout(ha,100);setTimeout(ha,500)});addEventListener('focus',ha);addEventListener('pageshow',ha);let st;addEventListener('scroll',()=>{clearTimeout(st);st=setTimeout(()=>{if(scrollY<=5)th()},150)},{passive:!0});let ty=0;document.addEventListener('touchstart',e=>{ty=e.touches[0].clientY},{passive:!0});document.addEventListener('touchend',e=>{const te=e.changedTouches[0].clientY;if(te>ty&&scrollY<=5)setTimeout(ha,100)},{passive:!0})}async function I(){await L();const ca=gc();if(ca){o=ca;d(o)}else sl();if(k)sk();else if(r)ss2();F();setInterval(u,T);setInterval(F,R);sb();sf()}if('serviceWorker'in navigator)navigator.serviceWorker.register('/sw.js').catch(e=>{});onclick=e=>{if(e.target==m)C()};addEventListener('popstate',function(e){const tm=document.getElementById('m'),cm2=document.getElementById('cm'),pm2=document.getElementById('pm'),to=tm&&tm.style.display==='block',co=cm2&&cm2.style.display==='block',po=pm2&&pm2.style.display==='block';if(to){tm.style.display='none';mo=!1}else if(co){cm2.style.display='none';mo=!1}else if(po)pm2.style.display='none';setTimeout(()=>history.pushState({page:'home'},'',location.href),10)},!1);addEventListener('beforeunload',function(e){},!1);document.addEventListener('contextmenu',e=>e.preventDefault());document.addEventListener('touchend',e=>{const t=Date.now();if(t-lt<=300)e.preventDefault();lt=t});document.addEventListener('keydown',e=>{if((e.key==='n'||e.key==='N')&&(e.ctrlKey||e.metaKey)){e.preventDefault();n()}else if(e.key==='Escape')C()});if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',I);else I()</script>
</body>
</html>